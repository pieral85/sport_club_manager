<?xml version="1.0" encoding="UTF-8"?>
<odoo>
    <data>
        <!-- Action Server -->
        <record id="action_calculate_membership_price_due" model="ir.actions.server">
            <field name="name">Calculate Memberships Price Due</field>
            <field name="type">ir.actions.server</field>
            <field name="model_id" ref="model_membership"/>
            <field name="state">code</field>
            <field name="code"><![CDATA[
for record in records:
    record._calculate_price_due()
]]>
            </field>
        </record>

        <!-- Enable a flag on the model -->
        <record id="sport_club_manager.model_membership" model="ir.model">
            <field name="website_form_access">True</field>
        </record>

        <!-- Allows membership to be able to be used by forms (whitelist the field(s) that can be used) -->
        <function model="ir.model.fields" name="formbuilder_whitelist">
            <value>sport_club_manager.membership</value>
            <value eval="['period_category_id']"/><!-- 'tutu',  -->
        </function>

        <!-- Add affiliation request in the website menu -->
        <record id="menu_membership" model="website.menu">
            <field name="name">Membership</field>
            <field name="parent_id" ref="website.main_menu"/>
            <field name="sequence" type="int">50</field>
        </record>
        <record id="menu_membership_request" model="website.menu">
            <field name="name">Make a request</field>
            <field name="url">sport/membership/request</field>
            <field name="parent_id" ref="menu_membership"/>
            <field name="sequence" type="int">10</field>
        </record>
        <record id="menu_membership_historical" model="website.menu">
            <field name="name">My historical</field>
            <field name="url">sport/my/membership/historical</field>
            <field name="parent_id" ref="menu_membership"/>
            <field name="sequence" type="int">20</field>
        </record>

        <!--Email template -->
        <record id="email_template_membership_affiliation_confirmation" model="mail.template">
            <field name="name">Membership Affiliation Confirmation</field>
            <field name="model_id" ref="model_membership"/>
            <field name="email_from"><![CDATA[
"${ctx['company_id'].name|safe}" <${(ctx['company_id'].email or user.email)|safe}>
]]>
            </field>
            <field name="subject">Confirmation of your affiliation for period ${object.period_category_id.period_id.name}</field>
            <field name="email_to"><![CDATA[${object.user_id.login or user.email or ''|safe}]]></field>
            <field name="auto_delete" eval="False"/>
            <field name="lang">${object.user_id.partner_id.lang}</field>
            <field name="body_html"><![CDATA[
<p>
    Dear ${(object.user_id.name or 'sportsperson')|safe},
</p>
<p>
We are pleased to let you know that you have been successfully affiliated for the season <u><i>${object.period_category_id.period_id.name|safe}<i><u>!
</p>
<p>
% if object.price_remaining:
Please note that you will have to pay ${object.price_remaining} on the account ${object.account_no}.
%else:
Please note that for this season, no price is due anymore.
% endif
</p>
<p>
If you have any question, do not hesitate to reply to this email.
</p>
<p>
We hope you will enjoy this new season with us!
</p>
<p>
Best regards,
</p>
<p>
${user.name}, for the ${ctx['company_id'].name|safe} comittee members
</p>
]]>
            </field>
        </record>
    </data>
</odoo>